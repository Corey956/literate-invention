---
layout: mypost
title: DNS原理以及其解析过程
categories: [网络]
extMath: true
---

# DNS原理以及其解析过程

首先了解一下为什么DNS解析域名为IP地址

现代的网络通讯大部分都是基于TCP/IP的，而TCP/IP是基于IP地址的，所以计算机在网络上进行通讯的时候只能识别IP地址，例如：“14.215.177.38”这样的IP地址，而不能认识域名，例如：“www.baidu.com”；然我我们无法记住多个IP地址，少量的还好，一旦多了起来那么就会混乱，所以当我们访问的网站的时候，多数都是直接在搜索栏使用输入域名，这样就能直接跳转到对应的网页，这是因为中间有个叫“DNS服务器”的计算机自动将域名翻译成了对应的IP地址，然后对应的IP地址页面对应上就直接返回200显示成功调用资源

那么问题来了，具体什么是DNS

## 具体的DNS

DNS（Domain Name System）是[域名系统](https://baike.baidu.com/item/%E5%9F%9F%E5%90%8D%E7%B3%BB%E7%BB%9F/2251573?fr=aladdin)的英文缩写，是一种组织成域层次结构的计算机和网络服务命名系统，它用于TCP/IP网络，它所提供的服务是用来将主机名和域名转换为IP地址的工作。DNS就是这样的一位“翻译官”，它的基本工作原理可用下图来表示

![image-20230321234953348](https://bear-iot-c-test.oss-cn-shenzhen.aliyuncs.com/biji/202303212349393.png)

## DNS的过程

关于DNS的获取流程：

DNS是应用层协议，事实上他是为其他应用层协议工作的，包括不限于HTTP和SMTP以及FTP，用于将用户提供的主机名解析为ip地址。

具体过程如下：

- 用户主机上运行着DNS的客户端，就是我们的PC机或者手机客户端运行着DNS客户端了
- 浏览器将接收到的url中抽取出域名字段，就是访问的主机名，比如：http://www.baidu.com/，并将这个主机名传送给DNS应用的客户端
- DNS客户端端向DNS服务器端发送一份查询报文，报文中包含着要访问的主机名字段（中间包括一些列缓存查询以及分布式DNS集群的工作）
- 该DNS客户端最终会收到一份回答报文，其中包含有该主机名对应的IP地址
- 一旦该浏览器收到来自DNS的IP地址，就可以向该IP地址定位的HTTP服务器发起TCP连接

## DNS服务的体系架构

**DNS domain name system**主要作用就是将主机域名转换为ip地址

假设运行在用户主机上的某些应用程序（如Webl浏览器或者邮件阅读器）需要将主机名转换为IP地址。这些应用程序将调用DNS的客户端端，并指明需要被转换的主机名。其实在很多基于`UNIX`的机器上，应用程序为了执行这种转换需要调用函数`gethostbyname（）`。用户主机的DNS客户端接收到后，向网络中发送一个DNS查询报文。所有DNS请求和回答报文使用的UDP数据报经过端口53发送

> **使用UDP的原因：**
>
> UDP（User Datagram Protocol）尽最大能力交付的不可靠数据连接
>
> TCP（Transmission Control Protocol传输控制协议）面向连接的可靠数据连接
>
> 一次UDP名字服务器交换可以短到两个包：一个查询包、一个响应包。一次TCP交换则至少包含9个包：三次握手初始化TCP会话、一个查询包、一个响应包以及四次分手的包交换。
>
> 考虑到效率原因，TCP连接的开销大，故采用UDP作为DNS的运输层协议，这也将导致只有13个根域名服务器的结果
>
> 所以DNS请求解析的时候只会在UDP报文中表明有截断的时候使用TCP查询

经过若干ms到若干s的延时后，用户主机上的DNS客户端接收到一个提供所希望映射的DNS回答报文。这个查询结果则被传递到调用DNS的应用程序。因此，从用户主机上调用应用程序的角度看，DNS是一个提供简单、直接的转换服务的黑盒子。**实现这个服务的黑盒子非常复杂，它由分布于全球的大量DNS服务器以及定义了DNS服务器与查询主机通信方式的应用层协议组成**

## DNS的设计方式

有人问过DNS的设计方式为什么是现在的这种分布式集群的设计方式，而不是单点集中的设计方式

DNS的一种简单的设计模式就是在网络上只使用一个DNS服务器，该服务器包含所有的映射，在这种单机的集中式设计中，客户端直接将所有查询请求发往单一的DNS服务器，同时该DNS服务器直接对所有查询客户端做出响应，尽管这种设计方式非常诱人，但他不适用当前的互联网，因为当今的网络上有着数量巨大并且在持续增长的主机，这种集中式设计会存在很大的隐患，那就是故障问题，DNS服务器出故障了，那么**全球的网络**将无法打开或正确查询到对应的IP地址，假设没有故障那么还存在以下的问题

- 服务器的通信容量：上十几亿台主机发送的查询DNS报文请求，包括但不限于所有的HTTP请求，电子邮件报文服务器，TCP长连接服务）
- 远距离的时间延迟：中国深圳到美国堪萨斯州
- 维护开销大：所有的主机名IP映射都要在一个服务站点更新等问题

DNS服务器一般分四种

- 根DNS服务器：最高层次的域名服务器，本地域名服务器解析不了的域名就会向其求助
- 顶级DNS服务器：负责管理在该顶级域名服务器下注册的二级域名
- 权限DNS服务器：负责一个区的域名解析工作
- 本地域名服务器：当一个主机发出DNS查询请求时，这个查询请求首先发给本地域名服务器

使用分布式的层次数据库模式以及缓存方法来解决单点集中式的问题

### DNS域名称

域名系统作为一个层次结构和分布式数据库，包含各种类型的数据，包括主机名和域名。DNS数据库中的名称形成一个分层树状结构称为域命名空间。域名包含单个标签分隔点，例如：

```text
www.baidu.com
```

完全限定的域名（FQDN）唯一地标识在**DNS**分层树中的主机的位置，通过指定的路径中点分隔从根引用的主机的名称列表。下图显示与主机称为www内

```text
baidu.com
```

DNS树的示例，主机的 FQDN 是

```text
 im.qq.com
```

### DNS域的名称层次结构

- 根域名 ：`.root` 或者 `.` ，根域名通常是省略的
- 顶级域名，如 `.com`，`.cn` 等
- 次级域名，如 `baidu.com` 里的 `baidu`，这个是用户可以进行注册购买的
- 主机域名，比如 `baike.baidu.com` 里的`baike`，这个是用户可分配的

![image-20230322021018073](https://bear-iot-c-test.oss-cn-shenzhen.aliyuncs.com/biji/202303220210139.png)

主机名.次级域名.顶级域名.根域名 

baike.baidu.com.root

用熟悉的百度来举例子：`www.baidu.com`

- com：一级域名，表示这是一个企业域名。同级的还有 “net”（网络提供商）, “org”（⾮非盈利组织）等
- baidu：二级域名，指公司名
- www：表示主机域名为 www

## DNS域名称空间的组织方式以及其层级有关要点

基本来说都是按照其中的功能命名空间中用来描述DNS域名称的五个类别，详情如下：

- 根域名：DNS域名中使用的时候规定都是由尾部是句号结尾
  - `www.baidu.com`的最完整的写发是`www.baidu.com.`
- 顶级域名（TLD）：用来指示某个国际/地区/组织使用的名称的类型名称，以及通用的顶级域名
  - 国家顶级域名如我们了解的 cn、jp等
  - 通用顶级域名如我们了解的 com、org、net、edu等，其中表示工商企业的是`.com`，表示网络提供商的`.net`，表示非盈利组织的`.org`，表示教育的`.edu`
- 二级域名：个人或组织在`Internet`
  - `baidu.com`
- 三级域名（子域名）：已经注册的二级域名派生的域名
  - `www.baidu.com`
- 三级域名下还可以在分支四级域名出来（主机名），DNS类似于Unix文件系统的结构，由根节点在上的反转树表示。最多分分支127层，每一层可以由最多63个字符组成，每层中间都以`.` 进行分隔，类似 Unix 文件中以`/`分隔每一个目录。域名的总长度不可超过255个字符，仅可使用字符、数字和连字符，不区分大小写

## DNS资源记录

在DNS服务器上，一个域名及其下级域名组成一个区域（Zone）。一个Zone的相关的DNS信息构成一个数据库文件，例如：一条A类型的资源记录，域名为`www.baidu.com`的数据为`14.215.177.38`

DNS数据库中包含的资源记录（RR）。每个RR标识数据库中的特定资源。我们在建立DNS服务器时，经常会用到SOA,NS,A之类的记录，在维护DNS服务器时，会用到MX，CNAME记录，当我们查询域名`www.baidu.com`的时候，查询结果得到的资源记录结构体中有如下数据

- TL，就是生存周期，是递归服务器会在缓存中保存该资源记录的时长
- 网络/协议类型，它的代表的标识是IN，IN就是internet，目前DNS系统主要支持的协议是IN
- type，就是资源记录类型，一般的网站都是都是A记录（IPv4的主机地址）
- rdata是资源记录数据，就是域名关联的信息数据

每个区域（Zone）数据库文件都是由资源记录（RR）构成的，一个资源记录就是一行文本，提供了一组有用的DNS配置信息。在DNS系统中，最常见的资源记录是Internet类记录，该记录由包含4个字段的数据构成：Name、Value、Type、TTL。其中Name和Value可以理解为一对键值对，但是其具体含义取决于Type的类型，TTL记录了该条记录应当从缓存中删除的时间

| 类型  | 编码 | 内容                                                         |
| ----- | ---- | ------------------------------------------------------------ |
| A     | 1    | 将DNS域名映射到`IP`v4 地址，基本作用是说明一个域名对应了哪些`IP`v4 地址 |
| NS    | 2    | 权威名称服务器记录，用于说明这个区域有哪些DNS服务器负责解析  |
| CNAME | 5    | 别名记录，主机别名对应的规范名称                             |
| SOA   | 6    | 起始授权机构记录，NS 记录说明了有多台服务器在进行解析，但哪一个才是主服务器，NS 并没有说明，SOA 记录了说明在众多 NS 记录里哪一台才是主要的服务器 |
| PTR   | 12   | IP 地址反向解析，是 A 记录的逆向记录，作用是把`IP` 地址解析为域名 |
| MX    | 15   | 邮件交换记录，指定负责接收和发送到域中的电子邮件的主机       |
| TXT   | 16   | 文本资源记录，用来为某个主机名或域名设置的说明               |
| AAAA  | 28   | 将DNS域名映射到`IP`v6 地址，基本作用是说明一个域名对应了哪些`IP`v6 地址 |

## Dns服务的工作过程

当DNS客户端需要查询程序中使用的名称时，它会查询本地DNS服务器来解析该名称。客户端发送的每条查询消息都包括3条信息，以指定服务器应回答的问题。

- 指定的DNS域名，表示为完全合格的域名（FQDN）
- 指定的查询类型，它可根据类型指定资源记录，或作为查询操作的专门类型
- DNS域名的指定类别
- 对于DNS服务器，它始终应指定为`Internet`类别。例如，指定的名称可以是计算机的完全合格的域名，如：`www.baidu.com`并且指定的查询类型用于通过该名称搜索地址资源记录

DNS查询以各种不同的方式进行解析。客户端有时也可通过使用从以前查询获得的缓存信息就地应答查询。DNS服务器可使用其自身的资源记录信息缓存来应答查询，也可代表请求客户端来查询或联系其他DNS服务器，以完全解析该名称，并随后将应答返回至客户端。这个过程称为递归。
另外，客户端自己也可尝试联系其他的DNS服务器来解析名称。如果客户端这么做，它会使用基于服务器应答的独立和附加的查询，该过程称作迭代，即DNS服务器之间的交互查询就是迭代查询。
DNS查询的过程如下图所示

![img](https://bear-iot-c-test.oss-cn-shenzhen.aliyuncs.com/biji/202303220409824.jpg)

### DNS解析过程

总体来说六个步骤，三大步：缓存找IP——本机的host文件找IP——DNS服务器查找IP

其小步骤如下：

#### 缓存查找IP

用户在通过浏览器浏览过某一个网站的时候，其浏览器就会自动缓存该网站域名对应的IP地址，当再次访问的时候就会直接从浏览器缓存中进行查找；但是浏览器的本地缓存有着大小限制，还有时间闲置，可以通过域名被缓存的时间通过`TTL`属性来设置，所以存在域名对应的`IP`找不到的情况。当浏览器从缓存中找到了该网站域名对应的`IP`地址，将进行下一步骤

> 对于其IP的缓存时间问题，一般来说不太适合设置太长的时间，如果时间太长，那么在这个时间内域名对应的IP地址发生变化，那么用户将在一段时间内无法正常的访问到网站，如果太短又会造成频繁解析域名

#### 本机的hosts文件查找IP

如果第一个步骤没有完成对域名的解析过程，那么浏览器会去系统hosts文件中，查找系统是否配置过这个域名对应的`IP`地址，可以理解为系统也具备域名配置的基本能力，如果hosts里没有这个域名的映射，则查找本地DNS解析器缓存，是否有这个网址映射关系，如果有，直接返回，完成域名解析

- 在`Windows`系统中，`hosts`文件位置在`C:\Windows\System32\drivers\etc\hosts`
- 在`Linux`或者`Mac`系统中，`hosts`文件在`/etc/hosts` 文件中

对于运维/开发，通过hosts绑定域名和`IP`，可以轻松切换环境

#### DNS服务器查找IP

如果在本地无法完成域名的解析，那么系统只能请求域名解析服务系统进行解析，首先会找TCP/IP参数中设置的首选DNS服务器，在这里我叫它本地DNS服务器，在此服务器收到查询时，如果要查询的域名，包含在本地配置区域资源中，则返回解析结果给客户端，完成域名解析，此解析具有**权威性**

本地域名系统`LDNS`一般都是本地区的域名服务器。local`DNS`(local name server)是客户端网络设置的一部分，要么是手工配置，要么从DHCP得到。一般local`DNS`在从网络上靠近客户端

- 比如你连接的校园网，那么域名解析系统就在你的校园机房里；
- 如果你连接的是电信、移动或者联通的网络，那么本地域名解析服务器就在本地区，由各自的运营商来提供服务

对于本地`DNS`服务器地址，`Windows`系统使用命令`ipconfig`就可以查看，在`Linux`和`Mac`系统下，直接使用命令`cat /etc/resolv.conf`来查看`LDNS`服务地址

`LDNS`一般都缓存了大部分的域名解析的结果，当然缓存时间也受域名失效时间控制，大部分的解析工作到这里就差不多已经结束了，`LDNS`负责了大部分的解析工作

如果本地DNS服务器本地区域文件与缓存解析都失效，则根据本地DNS服务器的设置（是否设置转发器）进行查询，如果未用转发模式，本地DNS就把请求发至13台根DNS，根DNS服务器收到请求后会判断这个域名(.com)是谁来授权管理，并会返回一个负责该顶级域名服务器的一个IP。本地DNS服务器收到IP信息后，将会联系负责.com域的这台服务器。这台负责.com域的服务器收到请求后，如果自己无法解析，它就会找一个管理.com域的下一级DNS服务器地址`www.baidu.com`给本地DNS服务器。当本地DNS服务器收到这个地址后，就会找`www.baidu.com`域服务器，重复上面的动作，进行查询，直至找到`www.baidu.com`主机

如果用的是转发模式，此DNS服务器就会把请求转发至上一级DNS服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根DNS或把转请求转至上上级，以此循环。不管是本地DNS服务器用是是转发，还是根提示，最后都是把结果返回给本地DNS服务器，由此DNS服务器再返回给客户端





#### `LDNS`解析的总体过程

![img](https://bear-iot-c-test.oss-cn-shenzhen.aliyuncs.com/biji/202303220425413.png)

#### `LDNS`总体来说

1. #### 从"根域名服务器"查到"一级域名服务器"的NS记录和A记录（IP地址）

2. 从"一级域名服务器"查到"二级域名服务器"的NS记录和A记录（IP地址）

3. 从"二级域名服务器"查出"主机名"的IP地址

### DNS 查询类型

从客户端出发，完整的DNS 查找过程中，会出现三种类型的查询。

通过组合使用这些查询，优化的`DNS`解析过程可缩短传输距离。

#### 递归查询

本机向本地域名服务器发出一次查询请求，就静待最终的结果。如果本地域名服务器无法解析，自己会以DNS客户端的身份向其它域名服务器查询，直到得到最终的IP地址告诉本机

![img](https://bear-iot-c-test.oss-cn-shenzhen.aliyuncs.com/biji/202303221432125.png)

> 在理想情况下，可以使用缓存的记录数据，从而使`DNS`域名服务器能够直接使用非递归查询

![img](https://bear-iot-c-test.oss-cn-shenzhen.aliyuncs.com/biji/202303221433454.png)

#### 迭代查询

本地域名服务器向根域名服务器查询，根域名服务器告诉它下一步到哪里去查询，然后它再去查，每次它都是以客户端的身份去各个服务器查询

![在这里插入图片描述](https://bear-iot-c-test.oss-cn-shenzhen.aliyuncs.com/biji/202303221449108.png)

迭代查询一般发生在`DNS Server`之间，当`Client`发出域名解析的请求后，`DNS Server`需要给予最佳答案，这个最佳答案可能是“距离最近”的顶级域名服务器，也能是权威域名服务器。无论如何，Client 需要对返回结果再次发起请求，知道获得最终结果

#### 非递归查询

可以理解为缓存查找或者一次搞定的查找

非递归查询发生在 Client 和`DNS Server`之间，指的是，请求的`DNS Server`已经知道答案，直接返回。这里可能有两种情况，一种是`DNS Server`本机缓存了对应的`IP`，或者是缓存了对应的域名的权威服务器。第二种情况只需要再发一次请求，即可拿到结果返回

当`DNS`解析器客户端查询`DNS`服务器以获取其有权访问的记录时通常会进行此查询，因为其对该记录具有权威性，或者该记录存在于其缓存内

DNS 服务器通常会缓存`DNS`记录，查询到来后能够直接返回缓存结果，以防止更多带宽消耗和上游服务器上的负载

![img](https://bear-iot-c-test.oss-cn-shenzhen.aliyuncs.com/biji/202303221455909.png)

![img](https://bear-iot-c-test.oss-cn-shenzhen.aliyuncs.com/biji/202303221455705.png)

**从递归和迭代查询可以看出：**

客户端-本地dns服务端：这部分属于递归查询。递归查询时，返回的结果只有两种:查询成功或查询失败.

本地dns服务端—外网：这部分属于迭代查询。迭代查询，又称作重指引,返回的是最佳的查询点或者主机地址.

### 详解：DNS 解析过程10个小步骤

1. 浏览器先检查自身缓存中有没有被解析过的这个域名对应的ip地址，如果有，解析结束。同时域名被缓存的时间也可通过TTL属性来设置
2. 如果浏览器缓存中没有/没有命中，浏览器会检查操作系统缓存中有没有对应的已解析过的结果。而操作系统也有一个域名解析的过程。在windows中可通过c盘里一个叫hosts的文件来设置，如果你在这里指定了一个域名对应的ip地址，那浏览器会首先使用这个ip地址
3. 如果至此还没有命中域名，才会真正的请求本地域名服务器（LDNS）来解析这个域名，这台服务器一般在你的城市的某个角落，距离你不会很远，并且这台服务器的性能都很好，一般都会缓存域名解析结果，大约80%的域名解析到这里就完成了。
4. 如果LDNS仍然没有命中，就直接跳到Root Server 域名服务器请求解析
5. 根域名服务器返回给LDNS一个所查询域的主域名服务器（gTLD Server，国际顶尖域名服务器，如.com .cn .org等）地址
6. 此时LDNS再发送请求给上一步返回的gTLD
7. 接受请求的gTLD查找并返回这个域名对应的Name Server的地址，这个Name Server就是网站注册的域名服务器
8. Name Server根据映射关系表找到目标ip，返回给LDNS
9. LDNS缓存这个域名和对应的ip
10. LDNS把解析的结果返回给用户，用户根据TTL值缓存到本地系统缓存中，域名解析过程至此结束

![img](https://bear-iot-c-test.oss-cn-shenzhen.aliyuncs.com/biji/202303221457407.png)